#!/bin/sh

LOCATION=Johor+Bahru
weatherreport="${XDG_DATA_HOME:-$HOME/.local/share}/weatherreport"
weatherreportmin="${XDG_DATA_HOME:-$HOME/.local/share}/weatherreportmin"
getforecast() { curl -sf "wttr.in/$LOCATION" > "$weatherreport" || exit 1 ;}
getforecastmin() { curl -sf "wttr.in/$LOCATION?format=%x%t" > "$weatherreportmin" || exit 1 ;}
showweather() {
    data=$(cat $weatherreportmin)
    arr=(${data//+/ })
    weat=${arr[0]}
    temp=${arr[1]}
    out=""
    case "$weat" in 
        "m" | "mm" | "mmm" | "=") out+="";;
        "///" | "//" | "**" | "*/*" | "/" | "." | "x" | "x/" | "*" | "*/") out+="" ;;
        "/!/" | "!/" | "*!*" ) out+="" ;;
        "o") 盛;;
    esac
    out+=" $temp"
    echo $out
}

case $BLOCK_BUTTON in
	1) setsid -f "$TERMINAL" -e less -Srf "$weatherreport" ;;
	3) "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

[ "$(stat -c %y "$weatherreport" 2>/dev/null | cut -d' ' -f1)" = "$(date '+%Y-%m-%d')" ] || getforecast &
[ "$(stat -c %y "$weatherreportmin" 2>/dev/null | cut -d' ' -f1)" = "$(date '+%Y-%m-%d')" ] || getforecastmin
showweather
